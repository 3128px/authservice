syntax = "proto3";

package authservice.config;

import "config/oidc/config.proto";
import "validate/validate.proto";

// Match specifies how a request can be matched to a filter chain.
message Match {
    // header specifies the http header used to match against.
    string header = 1 [(validate.rules).string.min_len = 1];
    oneof value {
        option (validate.required) = true;
        // prefix specifies the prefix of the header value upon which to match against.
        string prefix = 2 [(validate.rules).string.min_len = 1];
        // equality specifies the absolute value of a header value upon which to match against.
        string equality = 3  [(validate.rules).string.min_len = 1];
    }
}

// Filter represents a filter-specific configuration.
message Filter {
    oneof type {
        option (validate.required) = true;
        oidc.OIDCConfig oidc = 1;
    }
}

// FilterChain represents a chain of 1 or more filters that will sequentially process an HTTP request.
message FilterChain {
    // match describes a rule to determine whether an HTTP request should be processed.
    Match match = 1 [(validate.rules).message.required = true];
    // filter describes the configuration of one of more filters in the filter chain.
    repeated Filter filters = 2 [(validate.rules).repeated.min_items = 1];
}

message Config {
    // chains represents one of more processing chains for incoming requests. A chain is selected based on the first matched.
    // Order of chain declaration is therefore important.
    repeated FilterChain chains = 1 [(validate.rules).repeated.min_items = 1];
    // listen_address describes the address for the authservice to listen for incoming requests to process.
    string listen_address = 2 [(validate.rules).string.ip = true];
    // listen_port describes the port for the authservice to listen for incoming requests to process.
    int32 listen_port = 3 [(validate.rules).int32.lt = 65536];
    // log_level describes the verbosity of logs generated by the authservice.
    string log_level = 4 [(validate.rules).string = {in: ["trace", "debug", "info", "error", "critical"]}];
}
